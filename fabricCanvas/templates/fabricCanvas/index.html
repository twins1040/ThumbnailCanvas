{% load static %}
<!DOCTYPE html>
<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-128170153-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());

			gtag('config', 'UA-128170153-1');
	</script>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
	<!-- 위 3개의 메타 태그는 *반드시* head 태그의 처음에 와야합니다; 어떤 다른 콘텐츠들은 반드시 이 태그들 *다음에* 와야 합니다 -->
	<title>무료 유튜브 썸네일 만들기 사이트</title>
	<!-- 합쳐지고 최소화된 최신 CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	<!-- 부가적인 테마 -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

	<link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:400,700,800&amp;subset=korean" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:500,700,900&amp;subset=korean" rel="stylesheet">
	<link href="{% static "custom.css" %}" rel="stylesheet">
	<!-- IE8 에서 HTML5 요소와 미디어 쿼리를 위한 HTML5 shim 와 Respond.js -->
	<!-- WARNING: Respond.js 는 당신이 file:// 을 통해 페이지를 볼 때는 동작하지 않습니다. -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>

<body>




	<div class="container">
		<div class="jumbotron">
			<h1>무료 온라인 유튜브 썸네일</h1>
			<p class="lead">맘먹고 업로드한 동영상 조회수가 너무 낮으시다구요? 혹시 썸네일 문제는 아닐까요? 만들고는 싶은데 포토샵조차 설치되어있지 않으시다구요? 이제 걱정 마세요. 따끈따끈한 최신 템플릿을 온라인에서 무료로 제공해드립니다. 사진 한장만 업로드 하여 간판하게 편집해보세요. 모든 것은 완전히 무료입니다.</p>
		</div>
		<div class="page-header">
			<h2>Templetes</h2>
		</div>
		{% for tmpl in templates %}
			{% cycle '<div class="row">' '' '' %}
				<div>
					<div class="col-xs-4" onclick="canvas.loadFromJSON('{{tmpl.data}}')">
						<img class="img-thumbnail" src="{{tmpl.thumbnail}}" >
					</div>
				</div>
			{% cycle '' '' '</div>' as ptext %}
			{% if ptext == '' and forloop.last %}  </div> {% endif %}
		{% endfor %}
	</div>
	<div class="container" id="main-container">
		<div class="page-header">
			<h2>Canvas</h2>
		</div>
		<div class="container-canvas">
			<p>
				<input type="file" id="imgLoader"/>
			</p>
			<canvas id="myCanvas" width="800" height="450">
				Your browser does not support the canvas element
			</canvas>
			<canvas id="palette" width="800" height="150">
				Your browser does not support the canvas element
			</canvas>
		</div>
		<div class="container">
			<h1>
				<input type="button" class="btn btn-default" id="upload" value="Upload this for Template"/>
				<a id="download-btn-a">
					<input type="button" class="btn btn-primary" value="Download Thumbnail"/>
				</a>
			</h1>
		</div>
	</div>



	<!-- jQuery (부트스트랩의 자바스크립트 플러그인을 위해 필요합니다) -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<!-- 합쳐지고 최소화된 최신 자바스크립트 -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/holder/2.9.4/holder.min.js"></script>
	<!--<script src="node_modules/fabric/dist/fabric.js"></script>-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.1/fabric.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

	<script type="text/javascript">
		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}

		function Copy() {
			// clone what are you copying since you
			// may want copy and paste on different moment.
			// and you do not want the changes happened
			// later to reflect on the copy.
			canvas.getActiveObject().clone(function(cloned) {
				_clipboard = cloned;
			});
		}

		function Paste() {
			// clone again, so you can do multiple copies.
			_clipboard.clone(function(clonedObj) {
				canvas.discardActiveObject();
				clonedObj.set({
					left: clonedObj.left + 10,
					top: clonedObj.top + 10,
					evented: true,
				});
				if (clonedObj.type === 'activeSelection') {
					// active selection needs a reference to the canvas.
					clonedObj.canvas = canvas;
					clonedObj.forEachObject(function(obj) {
						canvas.add(obj);
					});
					// this should solve the unselectability
					clonedObj.setCoords();
				} else {
					canvas.add(clonedObj);
				}
				_clipboard.top += 10;
				_clipboard.left += 10;
				canvas.setActiveObject(clonedObj);
				canvas.requestRenderAll();
			});
		}

		function activeObjectSet(options, key, val) {
			actobj = canvas.getActiveObject();
			if (options.target && actobj) {
				canvas.getActiveObject().set(key, val);
				canvas.renderAll();
			}
		}

		function createColorGroup(len, gradient, colors) {
			var group = new fabric.Group();
			var offset = 0;

			group.selectable = false;
			group.subTargetCheck = true;

			for (i = 0; i < colors.length; i++) {
				var rect = new fabric.Rect({left:offset, width:len, height:len, selectable:false});
				var c = colors[i];

				if (gradient) {
					rect.setGradient('fill', {x1:0, y1:0, x2:len*c.h, y2:len*c.v, colorStops: c.stops});
					console.log(rect);
				} else {
					rect.fill = c;
				}
				group.addWithUpdate(rect);
				offset += len;
			}
			return group;
		}

		function arrangeObject(marginLeft, marginTop, arr) {
			var top = marginTop;
			for (i = 0; i < arr.length; i++) {
				var left = 0;
				var maxHeight = 0;
				for (j = 0; j < arr[i].length; j++) {
					var cell = arr[i][j];
					cell.set("top", top);
					cell.set("left", left);
					left += cell.width + marginLeft;
					if (cell.height > maxHeight) {
						maxHeight = cell.height;
					}
					palette.add(cell);
				}
				top += maxHeight + marginTop;
			}
		}

		var canvas = new fabric.Canvas('myCanvas');
		var palette = new fabric.Canvas('palette', {selection: false, hoverCursor: 'default'});

		canvas.setDimensions({width:1280, height:720}, {backstoreOnly:true});
		canvas.selection = true;
		canvas.on('mouse:down', function(opt) {console.log(opt)});

		// Pallete initial setting
		var defaultAttr = {fontSize: 16, selectable: false, backgroundColor: 'Gainsboro' };
		var textFillText = new fabric.Text("글자색:", defaultAttr);
		var strokeColorText = new fabric.Text("테두리색:", defaultAttr);
		var copyText = new fabric.Text("복사", defaultAttr);
		var pasteText = new fabric.Text("붙여넣기", defaultAttr);
		var deleteText = new fabric.Text("삭제", defaultAttr);
		var strokeThickerText = new fabric.Text("테두리굵게", defaultAttr);
		var strokeThinnerText = new fabric.Text("테두리얇게", defaultAttr);
		var fontNanumText = new fabric.Text("나눔고딕", defaultAttr);
		var fontNotoText = new fabric.Text("Noto Sans KR", defaultAttr);
		var gstroke = createColorGroup(20, false,
				["red", "orange", "yellow", "green", "blue", "purple", "black", "white", "cyan", "pink", "gray", "brown"]);
		var gfill = createColorGroup(20, false,
				["red", "orange", "yellow", "green", "blue", "purple", "black", "white", "cyan", "pink", "gray", "brown"]);
		var gradient1 = {h:0, v:1, stops:{0:"red", 1:"orange"}};
		var gradient2 = {h:0, v:1, stops:{0:"blue", 1:"darkblue"}};
		var gradient3 = {h:0, v:1, stops:{0:"red", 1:"darkred"}};
		var ggradient = createColorGroup(20, true, [gradient1, gradient2, gradient3]);

		arrangeObject(10, 10, [[copyText, pasteText, deleteText, strokeThickerText, strokeThinnerText, fontNanumText, fontNotoText],
							   [textFillText, gfill, ggradient],
							   [strokeColorText, gstroke]]);


		fontNanumText.fontFamily = "Nanum Gothic";
		fontNotoText.fontFamily = "Noto Sans KR";

		copyText.on('mouseup', Copy);
		pasteText.on('mouseup', Paste);

		deleteText.on('mouseup', function(options){
			var actobj = canvas.getActiveObject();
			canvas.remove(actobj);
		});

		gfill.on('mouseup', function(options) {
			activeObjectSet(options, "fill", options.subTargets[0].fill);
		});

		ggradient.on('mouseup', function(options) {
			var actobj = canvas.getActiveObject();
			var sub = options.subTargets[0];

			if (actobj) {
				var fc = $.extend({}, sub.fill);
				fc.coords.x2 = (sub.fill.coords.x2 ? 1:0) * actobj.width;
				fc.coords.y2 = (sub.fill.coords.y2 ? 1:0) * actobj.height;
				actobj.set("fill", fc);
				canvas.renderAll();
			}
		});

		gstroke.on('mouseup', function(options) {
			activeObjectSet(options, "stroke", options.subTargets[0].fill);
		});

		strokeThickerText.on('mouseup', function(options){
			var actobj = canvas.getActiveObject();
			activeObjectSet(options, "strokeWidth", actobj.strokeWidth+4);
		});

		strokeThinnerText.on('mouseup', function(options){
			var actobj = canvas.getActiveObject();
			activeObjectSet(options, "strokeWidth", actobj.strokeWidth-4);
		});

		fontNanumText.on('mouseup', function(options) {
			activeObjectSet(options, "fontFamily", "Nanum Gothic");
		});

		fontNotoText.on('mouseup', function(options) {
			activeObjectSet(options, "fontFamily", "Noto Sans KR");
		});

		// Event for download btn
		var link = document.getElementById("download-btn-a");
		link.addEventListener('click', function(ev) {
			link.href = canvas.toDataURL();
			link.download = "mypainting.png";
		}, false);


		// Create image loader btn
		document.getElementById('imgLoader').onchange = function handleImage(e) {
		var reader = new FileReader();
		  reader.onload = function (event){
			var imgObj = new Image();
			imgObj.src = event.target.result;
			imgObj.onload = function () {
			  var image = new fabric.Image(imgObj);
			  canvas.setBackgroundImage(image, canvas.renderAll.bind(canvas), {
				  scaleX: canvas.width / image.width,
				  scaleY: canvas.height / image.height,
				  // Needed to position backgroundImage at 0/0
				  originX: 'left',
				  originY: 'top'
			  });
			}
		  }
		  reader.readAsDataURL(e.target.files[0]);
		}


		// Set click event for template upload button
		$('#upload').click(function(){
			//to fix csrf error
			var csrftoken = Cookies.get('csrftoken');
			$.ajaxSetup({
				beforeSend: function(xhr, settings) {
					if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
						xhr.setRequestHeader("X-CSRFToken", csrftoken);
					}
				}
			});

			$.post("templates/", {thumbnail: canvas.toDataURL(), data: JSON.stringify(canvas)});
		});


		var ubuntuText = new fabric.IText("배그타임!", {
			fontFamily: 'Noto Sans KR',
			fontSize: 100,
			fontWeight: 900,
			fill: '#f442df',
			stroke: 'black',
			strokeWidth:20,
			paintFirst: 'stroke',
			charSpacing: -100,
			angle:  -5,
			top: 100

		});

		var copyText = new fabric.IText("");
		fabric.util.object.extend(copyText, ubuntuText);
		copyText.set('top', 200);
		copyText.set('text', "쟁니랑");
		copyText.set('fill', 'white');

		var copyText2 = new fabric.IText("");
		fabric.util.object.extend(copyText2, ubuntuText);
		copyText2.set('top', 300);
		copyText2.set('text', "명욱이랑");
		copyText2.set('fill', 'red');

		canvas.add(ubuntuText);
		canvas.add(copyText);
		canvas.add(copyText2);

		// Set first templete in canvas
		$(".col-xs-4").get(-1).onclick()

	</script>


</body>
</html>
